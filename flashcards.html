<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flashcard Generator | Tom Harrysson</title>
  <style>
    :root {
      --bg-gradient-start: #e2e8f0;
      --bg-gradient-mid: #cbd5e1;
      --bg-gradient-end: #94a3b8;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --card-bg: rgba(255,255,255,0.95);
      --header-content-text: #1e293b;
      --section-bg: #f8fafc;
      --border-color: #e2e8f0;
      --accent-primary: #0891b2;
      --info-box-text: #78350f;
      --info-box-h3: #92400e;
      --success: #15803d;
      --warn: #b45309;
      --danger: #dc2626;
    }
    body.dark-mode {
      --bg-gradient-start: #0f172a;
      --bg-gradient-mid: #1e293b;
      --bg-gradient-end: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #e2e8f0;
      --text-muted: #cbd5e1;
      --card-bg: rgba(51,65,85,0.95);
      --header-content-text: #f8fafc;
      --section-bg: #475569;
      --border-color: #64748b;
      --accent-primary: #06b6d4;
      --info-box-text: #fde68a;
      --info-box-h3: #fde68a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Georgia", serif;
      background: linear-gradient(135deg,var(--bg-gradient-start) 0%,var(--bg-gradient-mid) 50%,var(--bg-gradient-end) 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-primary);
      transition: all .3s ease;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,.1);
    }
    .dark-toggle {
      position: absolute; top: 20px; right: 20px;
      background: var(--card-bg); border: none; border-radius: 50%;
      width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;
    }
    a.back-link {
      display: inline-block; margin-bottom: 20px; color: var(--accent-primary);
      text-decoration: none; font-weight: 600;
    }
    a.back-link:hover { text-decoration: underline; }
    h1 { color: var(--header-content-text); font-size: 2rem; margin-bottom: 10px; text-align: center; }
    .subtitle { color: var(--text-primary); opacity: .8; text-align: center; margin-bottom: 30px; }

    .section {
      margin-bottom: 30px; padding: 25px; background: var(--section-bg); border-radius: 12px;
    }
    .section h2 {
      color: var(--header-content-text); font-size: 1.5rem; margin-bottom: 20px;
      border-bottom: 2px solid var(--accent-primary); padding-bottom: 10px;
    }
    .info-box {
      background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;
    }
    body.dark-mode .info-box { background: #78350f; border-left-color: #fbbf24; }
    .info-box h3 { color: var(--info-box-h3); margin-bottom: 10px; }
    .info-box ol, .info-box p { color: var(--info-box-text); line-height: 1.7; margin-left: 20px; }

    label { font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 8px; }
    select, input[type="text"] {
      width: 100%; max-width: 420px; padding: 10px; border: 2px solid var(--border-color);
      border-radius: 8px; font-size: 1rem; background: var(--card-bg); color: var(--text-primary);
    }
    textarea {
      width: 100%; padding: 15px; border: 2px solid var(--border-color);
      border-radius: 8px; font-size: 1rem; background: var(--card-bg); color: var(--text-primary);
      font-family: "Courier New", monospace; min-height: 200px; resize: vertical;
    }
    button, .file-upload-label {
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--accent-primary), #06b6d4);
      color: #fff; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;
      transition: all .3s ease; font-size: 1rem; margin-right: 10px; display: inline-block;
    }
    button:hover:not(:disabled), .file-upload-label:hover {
      transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.2);
    }
    button:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }
    #uploadFile { display: none; }

    .button-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .error-message {
      background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;
    }
    body.dark-mode .error-message { background: #7f1d1d; color: #fca5a5; }
    .error-message.show { display: block; }

    .preview { display: none; }
    .preview.show { display: block; }
    .card {
      background: var(--card-bg); padding: 18px; border-radius: 12px; margin-bottom: 14px; border-left: 4px solid var(--accent-primary);
    }
    .card h4 { margin-bottom: 10px; }
    .card .text { line-height: 1.7; }
    .pill {
      display: inline-block; padding: 2px 8px; border-radius: 999px; background: var(--section-bg);
      border: 1px solid var(--border-color); font-size: .8rem; color: var(--text-muted); margin-right: 6px;
    }
    .helper { font-size: .9rem; color: var(--text-muted); margin-top: 14px; line-height: 1.7; }
    .muted { opacity: .8; color: var(--text-secondary); }
    .success { color: var(--success); }
    .warn { color: var(--warn); }
    .danger { color: var(--danger); }
    .tiny { font-size: .85rem; }

    pre.prompt {
      background: var(--section-bg); padding: 15px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap;
    }
    .cloze-chip { background: #fde68a; padding: 0 4px; border-radius: 4px; }
    body.dark-mode .cloze-chip { background: #78350f; }
    .reveal {
      background: transparent; color: var(--accent-primary); border: 1px dashed var(--accent-primary);
      padding: 4px 8px; border-radius: 8px; margin-left: 8px;
    }
    .reveal:hover { transform: none; box-shadow: none; }
    .tagline { text-align: center; margin-top: 16px; color: var(--text-muted); }
    @media (max-width: 768px) { .container { padding: 20px; } }
  </style>
</head>
<body>
  <button id="darkToggle" class="dark-toggle"><span id="darkIcon">üåô</span></button>
  <div class="container">
    <a href="tools.html" class="back-link">‚Üê Back to Tools</a>
    <h1>üß† Flashcard Generator</h1>
    <p class="subtitle">Build high-yield Anki cards from any text, lecture notes, or slides.</p>

    <div class="info-box">
      <h3>üìã How this works</h3>
      <ol>
        <li>Choose card mode (<strong>Cloze</strong> recommended), cloze aggressiveness, and tags.</li>
        <li>Click <em>Copy Prompt</em> and paste it into ChatGPT with your source content (slides/paragraphs, etc.).</li>
        <li>Copy the JSON output from ChatGPT (whole code block is fine).</li>
        <li>Paste it below or upload the file. Preview cards (Reveal shows answers/hints), then export as <strong>TSV</strong> for Anki.</li>
        <li>In Anki, import the TSV and select the <strong>Cloze</strong> (or <strong>Basic</strong>) note type.</li>
      </ol>
      <p class="helper tiny">Tip: Keep relevant clarifications in the <strong>Extra</strong> field‚Äîmnemonics, disambiguators, or short differentials for context.</p>
    </div>

    <!-- Config -->
    <div class="section">
      <h2>Step 1: Configure</h2>
      <div style="display:grid; gap:18px; grid-template-columns: 1fr 1fr; max-width:860px;">
        <div>
          <label for="mode">Card Mode</label>
          <select id="mode">
            <option value="cloze" selected>Cloze (recommended)</option>
            <option value="basic">Basic (Front/Back)</option>
          </select>
          <p class="helper">Cloze text like: <span class="cloze-chip">{{c1::Bohr effect::right-shift}}</span></p>
        </div>
        <div id="clozeAggWrap">
          <label for="clozeAgg">Cloze Aggressiveness</label>
          <select id="clozeAgg">
            <option value="low">Low (few deletions)</option>
            <option value="moderate" selected>Moderate (smart)</option>
            <option value="high">High (many deletions)</option>
          </select>
          <p class="helper">Controls how dense the clozes should be.</p>
        </div>
        <div>
          <label for="tagInput">Tags (space or comma separated)</label>
          <input type="text" id="tagInput" placeholder="e.g. cardio heme respiratory"/>
          <p class="helper">Only these tags will be applied to every card. (Per-card tags from ChatGPT are ignored.)</p>
        </div>
        <div>
          <label for="cardLimit">Max Cards</label>
          <select id="cardLimit">
            <option>10</option>
            <option selected>20</option>
            <option>30</option>
            <option>40</option>
            <option>50</option>
          </select>
          <p class="helper">Ask ChatGPT not to exceed this amount.</p>
        </div>
      </div>
    </div>

    <!-- Prompt -->
    <div class="section">
      <h2>Step 2: Copy ChatGPT Prompt</h2>
      <div class="button-group">
        <button id="copyPromptBtn">üìã Copy Prompt to Clipboard</button>
      </div>
      <pre id="promptText" class="prompt" spellcheck="false"></pre>
      <p class="tagline tiny">Paste this prompt into ChatGPT, then paste the JSON it returns in Step 3.</p>
    </div>

    <!-- Input -->
    <div class="error-message" id="errorMessage"></div>
    <div class="section" id="inputSection">
      <h2>Step 3: Paste JSON or Upload File</h2>
      <textarea id="jsonInput" placeholder='Paste the JSON here (the tool will strip ``` fences automatically)'></textarea>
      <div class="button-group" style="margin-top:10px;">
        <button id="loadBtn">Load Cards</button>
        <label for="uploadFile" class="file-upload-label">Upload JSON</label>
        <input type="file" id="uploadFile" accept=".json,.txt"/>
        <button id="clearBtn">Clear</button>
      </div>
    </div>

    <!-- Preview -->
    <div id="preview" class="preview">
      <div class="section">
        <h2>Preview</h2>
        <div id="previewList"></div>
      </div>

      <div class="section">
        <h2>Export</h2>
        <div class="button-group">
          <button id="exportTSVBtn">‚¨áÔ∏è Download Anki TSV</button>
          <button id="downloadJsonBtn">‚¨áÔ∏è Download JSON</button>
          <button id="resetBtn">Start Over</button>
        </div>
        <p class="helper tiny" style="margin-top:10px;">
          <strong>In Anki:</strong> File ‚Üí Import ‚Üí choose the TSV ‚Üí set <em>Note Type</em> to <strong>Cloze</strong> (for cloze cards) or <strong>Basic</strong> (for basic cards). For Cloze, map the first field to ‚ÄúText‚Äù and second to ‚ÄúExtra‚Äù; Tags import automatically.
        </p>
      </div>
    </div>
  </div>

  <script>
    // ---------- State ----------
    let cards = []; // normalized internal representation
    let mode = "cloze";

    // ---------- Helpers ----------
    function qs(id){ return document.getElementById(id); }
    function showError(msg){
      const el = qs('errorMessage');
      el.textContent = msg; el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 5000);
    }
    function getGlobalTags(){
      const raw = qs('tagInput').value.trim();
      if(!raw) return [];
      return raw.split(/[,\s]+/).filter(Boolean);
    }
    function sanitizeFences(txt){
      return txt.replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();
    }

    // ---------- Prompt Builder ----------
    function buildPrompt(){
      mode = qs('mode').value;
      const limit = qs('cardLimit').value;
      const agg = qs('clozeAgg').value;
      const sharedTags = getGlobalTags().join(' ');

      const aggressivenessText = {
        low: "Use few cloze deletions‚Äîonly the highest-yield terms (eponyms, definitions, key steps, formula pivots).",
        moderate: "Use smart, concise clozes on high-yield concepts, names, numbers, and cause‚Üíeffect pivots. Avoid over-clozing.",
        high: "Use many cloze deletions but still avoid fragmenting sentences; prioritize density while keeping each card answerable."
      }[agg];

      const baseRules = `
General rules (output strictly as JSON array inside a \`\`\`json code block):
- Do not exceed ${limit} cards.
- Produce self-contained, unambiguous cards.
- Use the Minimal Information Principle; one atomic fact per cloze.
- Prefer high-yield material; skip trivia and long lists unless core.
- Use concise phrasing; keep context sufficient for recall.
- Include an optional "extra" field for short clarifications/mnemonics only when helpful.
- **Do not include a tags array**. Tags are applied by my website.
`;

      const goodAnki = `

üß† CLOZE CARD RULESET (Concise)

Core Principle:
Each cloze tests one atomic, high-yield fact with enough‚Äîbut not excessive‚Äîcontext to allow precise recall without guesswork.

1) Context Balance
- Provide just enough context to be answerable but not guessable.
- Too little ‚Üí ambiguity; too much ‚Üí giveaway.
- Ideal: ‚Äú{{c1::ADH}} increases water reabsorption in the collecting duct.‚Äù

2) Minimal Information
- One fact per cloze; split related facts. Retrieval <5s.

3) Self-contained
- Full sentence(s) that make sense alone; avoid pronouns like ‚Äúit/this‚Äù.

4) Clarity
- Clean sentences; avoid obscure abbreviations; prefer cause‚Üíeffect/mechanism‚Üíoutcome.

5) Relevance
- High-yield only; skip trivia and long lists unless core.

6) Hint System
- Use hints only when multiple plausible answers exist; hints specify the category/type, not the identity.
- Syntax: {{c1::answer::hint}}.
- Good: {{c1::ADH::hormone}} acts on the distal nephron.
- Don‚Äôt use hints when context already makes the target unambiguous or when hint restates the answer or makes it obvious.

7) Structure
- Number clozes sequentially (c1, c2, c3), no overlaps, cloze whole terms/phrases.

8) Extra Field
- Use \"extra\" only for short mnemonics/clarifications/exceptions; never add new lists or unrelated facts.

9) Simplicity
- Short, declarative, readable.

10) Quality Check
- Is recall dependent on knowing the fact (not deduction)?
- One atomic target? Enough but not excessive context?
- Would a hint help without giving it away? High-yield, <5s recall?
`;

      let schemaText = '';
      if(mode === 'cloze'){
        schemaText = `
Cloze card schema (array of objects):
[
  {
    "text": "Full sentence(s) with {{c1::target}} cloze(s). Optional hints: {{c2::target::short hint}}.",
    "extra": "Optional extra context / mnemonic"
  }
]

Cloze quality guidance:
- ${aggressivenessText}
- Do not repeat the same fact with multiple clozes.
`;
      } else {
        schemaText = `
Basic card schema (array of objects):
[
  {
    "front": "Question or prompt (specific)",
    "back": "Clear, unique best answer",
    "extra": "Optional extra context / mnemonic"
  }
]

Basic quality guidance:
- Split multi-part answers into separate cards.
- Keep the back concise and precise.
`;
      }

      const tagNote = sharedTags ? `\n(Website will apply these tags to every card: ${sharedTags})\n` : '';

      const prompt = `You are generating high-yield ${mode === 'cloze' ? 'Cloze' : 'Basic'} Anki flashcards from the content I provide.
\n${baseRules}${goodAnki}${schemaText}${tagNote}
Now read the content below and produce ONLY the JSON array inside a \`\`\`json code block.
\n[PASTE YOUR CONTENT BELOW THIS LINE]
`;
      qs('promptText').textContent = prompt;
    }

    // ---------- UI Wiring ----------
    function toggleDarkMode(){
      document.body.classList.toggle('dark-mode');
      const icon = qs('darkIcon');
      if(document.body.classList.contains('dark-mode')){
        localStorage.setItem('darkMode','enabled'); icon.textContent = '‚òÄÔ∏è';
      } else {
        localStorage.setItem('darkMode','disabled'); icon.textContent = 'üåô';
      }
    }

    function refreshAggVisibility(){
      qs('clozeAggWrap').style.display = (qs('mode').value === 'cloze') ? 'block' : 'none';
    }

    function copyPrompt(button){
      const text = qs('promptText').textContent;
      navigator.clipboard.writeText(text).then(()=>{
        const old = button.textContent, oldBg = button.style.background;
        button.textContent = '‚úì Copied!'; button.style.background = '#22c55e';
        setTimeout(()=>{ button.textContent = old; button.style.background = oldBg; }, 1600);
      }).catch(err=> alert('Copy failed: '+err));
    }

    // ---------- Parsing & Normalization ----------
    function normalizeInput(json){
      const sharedTags = getGlobalTags(); // apply ONLY these; ignore per-item tags
      const out = [];
      json.forEach((item, idx)=>{
        if(qs('mode').value === 'cloze'){
          if(!item.text) throw new Error(`Item ${idx+1}: missing "text"`);
          const extra = item.extra || "";
          out.push({ type: 'cloze', text: String(item.text), extra: String(extra), tags: sharedTags.slice() });
        } else {
          if(!item.front || !item.back) throw new Error(`Item ${idx+1}: missing "front" or "back"`);
          const extra = item.extra || "";
          out.push({ type: 'basic', front: String(item.front), back: String(item.back), extra: String(extra), tags: sharedTags.slice() });
        }
      });
      return out;
    }

    function parseAndLoad(){
      let raw = qs('jsonInput').value.trim();
      if(!raw){ showError('Please paste or upload JSON first.'); return; }

      raw = sanitizeFences(raw);
      let parsed;
      try{
        parsed = JSON.parse(raw);
      } catch(e){
        showError('Invalid JSON: '+e.message);
        return;
      }
      if(!Array.isArray(parsed) || parsed.length===0){
        showError('JSON must be a non-empty array.'); return;
      }
      try{
        cards = normalizeInput(parsed);
      } catch(e){
        showError(e.message); return;
      }
      renderPreview();
      qs('preview').classList.add('show');
      document.getElementById('preview').scrollIntoView({behavior:'smooth'});
    }

    // ---------- Preview Rendering ----------
    function renderPreview(){
      const list = qs('previewList');
      list.innerHTML = '';
      cards.forEach((c, i)=>{
        const div = document.createElement('div');
        div.className = 'card';

        if(c.type === 'cloze'){
          const html = renderClozeHTML(c.text);
          div.innerHTML = `
            <h4>Card ${i+1} <span class="pill">Cloze</span> ${c.tags.map(t=>`<span class="pill">${t}</span>`).join('')}</h4>
            <div class="text">${html}</div>
            ${c.extra ? `<div class="helper"><strong>Extra:</strong> ${escapeHTML(c.extra)}</div>` : ''}
          `;
          // hook up reveal buttons
          setTimeout(()=> div.querySelectorAll('.reveal').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const target = btn.previousElementSibling;
              if(target.dataset.answerShown === '1'){
                target.textContent = target.dataset.mask; target.dataset.answerShown = '0';
                btn.textContent = 'Reveal';
              } else {
                target.textContent = target.dataset.answer; target.dataset.answerShown = '1';
                btn.textContent = 'Hide';
              }
            });
          }),0);
        } else {
          div.innerHTML = `
            <h4>Card ${i+1} <span class="pill">Basic</span> ${c.tags.map(t=>`<span class="pill">${t}</span>`).join('')}</h4>
            <div class="text"><strong>Front:</strong> ${escapeHTML(c.front)}</div>
            <div class="text"><strong>Back:</strong> ${escapeHTML(c.back)}</div>
            ${c.extra ? `<div class="helper"><strong>Extra:</strong> ${escapeHTML(c.extra)}</div>` : ''}
          `;
        }
        list.appendChild(div);
      });
    }

    function escapeHTML(s){
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function renderClozeHTML(text){
      // Show masked clozes with a toggle; capture optional hint
      // Matches {{cN::answer}} or {{cN::answer::hint}}
      const regex = /\{\{c(\d+)::(.*?)(?:::(.*?))?\}\}/g;
      let idx = 0;
      return escapeHTML(text).replace(regex, (m, n, ans, hint)=>{
        const mask = '‚ñÆ‚ñÆ‚ñÆ';
        const id = 'cz_'+(idx++);
        const safeHint = hint ? ` title="Hint: ${escapeHTML(hint)}"` : '';
        return `<span class="cloze-chip" data-id="${id}" data-answer="${escapeHTML(ans)}" data-mask="${mask}" data-answer-shown="0">${mask}</span><button class="reveal tiny"${safeHint}>Reveal</button>`;
      });
    }

    // ---------- Exporters ----------
    // TSV format: fields separated by tab, rows by newline.
    // For Cloze: Field1=Text (with {{c::}}), Field2=Extra, Tags=space-separated
    // For Basic: Field1=Front, Field2=Back, Field3=Extra, Tags=space-separated
    function exportTSV(){
      if(cards.length === 0){ showError('No cards to export.'); return; }
      let tsv = '';
      const tagJoin = (tags) => (tags||[]).join(' ');
      if(cards[0].type === 'cloze'){
        tsv = cards.map(c => [ c.text, (c.extra||''), tagJoin(c.tags) ].join('\t')).join('\n');
        downloadFile(tsv, 'anki-cloze', 'tsv', 'text/tab-separated-values;charset=utf-8');
      } else {
        tsv = cards.map(c => [ c.front, c.back, (c.extra||''), tagJoin(c.tags) ].join('\t')).join('\n');
        downloadFile(tsv, 'anki-basic', 'tsv', 'text/tab-separated-values;charset=utf-8');
      }
    }

    function downloadJSON(){
      if(cards.length===0){ showError('Nothing to download.'); return; }
      const pretty = JSON.stringify(cards, null, 2);
      downloadFile(pretty, 'flashcards', 'json', 'application/json');
    }

    function downloadFile(content, base, ext, mime){
      const date = new Date().toISOString().slice(0,10);
      const blob = new Blob([content], { type: mime || 'text/tab-separated-values;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${base}-${date}.${ext}`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ---------- File Upload ----------
    function handleFileUpload(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        qs('jsonInput').value = ev.target.result;
        parseAndLoad();
      };
      reader.onerror = ()=> showError('Error reading file.');
      reader.readAsText(file);
    }

    // ---------- Reset/Clear ----------
    function resetAll(){
      cards = [];
      qs('jsonInput').value = '';
      qs('uploadFile').value = '';
      qs('preview').classList.remove('show');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function clearInput(){
      qs('jsonInput').value = '';
      qs('uploadFile').value = '';
    }

    // ---------- Init ----------
    window.addEventListener('DOMContentLoaded', ()=>{
      if(localStorage.getItem('darkMode')==='enabled'){
        document.body.classList.add('dark-mode'); qs('darkIcon').textContent='‚òÄÔ∏è';
      }
      qs('darkToggle').addEventListener('click', toggleDarkMode);

      ['mode','clozeAgg','cardLimit','tagInput'].forEach(id => qs(id).addEventListener('change', ()=>{
        refreshAggVisibility(); buildPrompt();
      }));
      refreshAggVisibility(); buildPrompt();

      qs('copyPromptBtn').addEventListener('click', function(){ copyPrompt(this); });
      qs('loadBtn').addEventListener('click', parseAndLoad);
      qs('clearBtn').addEventListener('click', clearInput);
      qs('resetBtn').addEventListener('click', resetAll);
      qs('exportTSVBtn').addEventListener('click', exportTSV);
      qs('downloadJsonBtn').addEventListener('click', downloadJSON);
      qs('uploadFile').addEventListener('change', handleFileUpload);
    });
  </script>
</body>
</html>
